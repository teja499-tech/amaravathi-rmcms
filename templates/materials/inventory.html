{% extends 'base.html' %}

{% block title %}Inventory Management{% endblock %}

{% block extra_css %}
<style>
    .low-stock {
        background-color: rgba(255, 0, 0, 0.05);
        border-left: 3px solid #dc3545;
    }
    .negative-stock {
        color: #dc3545;
        font-weight: bold;
    }
    .card-counter {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
        border-radius: 10px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
    }
    .card-counter:hover {
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        transform: translateY(-3px);
    }
    .card-counter.danger {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: #fff;
    }
    .card-counter .icon-container {
        font-size: 4em;
        opacity: 0.2;
        margin-right: 20px;
    }
    .card-counter .count-details {
        z-index: 1;
    }
    .card-counter .count-numbers {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 0;
    }
    .card-counter .count-name {
        font-size: 16px;
        opacity: 0.9;
    }
    
    /* Action buttons */
    .action-button {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }
    .action-button:hover {
        transform: translateY(-2px);
    }
    .action-button.view {
        background-color: #e9ecef;
        color: #495057;
    }
    .action-button.edit {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    .action-button.add {
        background-color: #d4edda;
        color: #198754;
    }
    
    /* Custom filter styles */
    .filter-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .search-input {
        border-radius: 6px 0 0 6px;
        border-right: none;
    }
    .search-button {
        border-radius: 0 6px 6px 0;
        background-color: #6c757d;
        color: white;
    }
    .search-button:hover {
        background-color: #5a6268;
        color: white;
    }
    .clear-button {
        border-color: #6c757d;
        color: #6c757d;
        font-weight: 500;
    }
    .clear-button:hover {
        background-color: #6c757d;
        color: white;
    }
    
    /* Table styles */
    .inventory-table {
        border-radius: 10px;
        overflow: hidden;
    }
    .inventory-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .inventory-table tbody tr:hover {
        background-color: rgba(0,0,0,0.02);
    }
    
    /* Modal improvements */
    .stock-modal .modal-header {
        background-color: #f8f9fa;
        border-radius: 10px 10px 0 0;
    }
    .stock-modal .modal-content {
        border-radius: 10px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .stock-modal .modal-footer {
        border-top: 1px solid #eee;
    }
    
    /* Reference type notes and fields */
    .reference-note {
        display: none;
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-size: 0.875rem;
    }
    
    .reference-note.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Inventory Management</h1>
        
        <div>
            <a href="{% url 'materials:material_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Add New Material
            </a>
        </div>
    </div>
    
    <!-- Stock Status Card -->
    {% if low_stock_count > 0 %}
    <div class="row mb-4">
        <div class="col-md-6 col-lg-4">
            <div class="card-counter danger">
                <div class="icon-container">
                <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="count-details">
                    <p class="count-numbers">{{ low_stock_count }}</p>
                    <p class="count-name">Materials below threshold</p>
                    <a href="?stock_status=low" class="btn btn-light btn-sm mt-2">View Low Stock</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Filters -->
    <div class="filter-container">
        <form method="get" id="inventory-filter-form">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="q" class="form-label fw-medium"><i class="bi bi-search me-1"></i>Search Materials</label>
                    <div class="input-group">
                        <input type="text" class="form-control search-input" id="q" name="q" value="{{ search_query }}" placeholder="Search by name or description...">
                        <button class="btn search-button" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <label for="stock_status" class="form-label fw-medium"><i class="bi bi-bar-chart me-1"></i>Stock Status</label>
                    <select class="form-select" id="stock_status" name="stock_status">
                        <option value="" {% if not stock_status %}selected{% endif %}>All Status</option>
                        <option value="low" {% if stock_status == 'low' %}selected{% endif %}>Low Stock</option>
                        <option value="normal" {% if stock_status == 'normal' %}selected{% endif %}>Normal Stock</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="last_updated" class="form-label fw-medium"><i class="bi bi-calendar-check me-1"></i>Last Updated</label>
                    <select class="form-select" id="last_updated" name="last_updated">
                        <option value="" {% if not last_updated %}selected{% endif %}>Any Time</option>
                        <option value="today" {% if last_updated == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if last_updated == 'week' %}selected{% endif %}>Last 7 Days</option>
                        <option value="month" {% if last_updated == 'month' %}selected{% endif %}>Last 30 Days</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <a href="{% url 'materials:inventory_list' %}" class="btn clear-button w-100">
                        <i class="bi bi-x-circle me-1"></i> Clear Filters
                    </a>
                </div>
                </div>
            </form>
    </div>
    
    <!-- Inventory Table -->
    <div class="card shadow inventory-table mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="ps-3">Material Name</th>
                            <th>Unit</th>
                            <th>Current Stock</th>
                            <th>Min Threshold</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th class="text-end pe-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr class="{% if material.current_stock < material.reorder_level %}low-stock{% endif %}">
                            <td class="ps-3">
                                <a href="{% url 'materials:material_detail' material.id %}" class="fw-medium text-decoration-none">{{ material.name }}</a>
                                {% if material.description %}<br><small class="text-muted">{{ material.description|truncatechars:50 }}</small>{% endif %}
                            </td>
                            <td>{{ material.unit }}</td>
                            <td class="{% if material.current_stock < 0 %}negative-stock{% endif %}">{{ material.current_stock }}</td>
                            <td>{{ material.reorder_level }}</td>
                            <td>
                                {% if material.current_stock < material.reorder_level %}
                                    <span class="badge bg-danger">Low Stock</span>
                                {% else %}
                                    <span class="badge bg-success">Normal</span>
                                {% endif %}
                            </td>
                            <td>{{ material.updated_at|date:"Y-m-d H:i" }}</td>
                            <td class="text-end pe-3">
                                <div class="btn-group">
                                    <a href="{% url 'materials:material_detail' material.id %}" class="action-button view me-1" title="View details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'materials:material_update' material.id %}" class="action-button edit me-1" title="Edit material">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="action-button add" data-bs-toggle="modal" data-bs-target="#addStockModal{{ material.id }}" title="Update stock">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                
                                <!-- Add Stock Modal -->
                                <div class="modal fade stock-modal" id="addStockModal{{ material.id }}" tabindex="-1" aria-labelledby="addStockModalLabel{{ material.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="addStockModalLabel{{ material.id }}">
                                                    <i class="bi bi-box-seam me-2"></i>Update Stock: {{ material.name }}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{% url 'materials:inventory_update' %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="material_id" value="{{ material.id }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="entry_type_{{ material.id }}" class="form-label">Entry Type</label>
                                                        <select class="form-select entry-type-select" id="entry_type_{{ material.id }}" name="entry_type" required>
                                                            <option value="IN">Stock In (Add to inventory)</option>
                                                            <option value="OUT">Stock Out (Remove from inventory)</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="quantity_{{ material.id }}" class="form-label">Quantity ({{ material.unit }})</label>
                                                        <input type="number" step="0.01" min="0.01" class="form-control" id="quantity_{{ material.id }}" name="quantity" required>
                                                        <div class="form-text">Current stock: {{ material.current_stock }} {{ material.unit }}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="reference_type_{{ material.id }}" class="form-label">Reference Type</label>
                                                        <select class="form-select reference-type-select" id="reference_type_{{ material.id }}" name="reference_type" required>
                                                            <option value="PURCHASE">Purchase Order</option>
                                                            <option value="SALE">Sale Order</option>
                                                            <option value="ADJUSTMENT">Manual Adjustment</option>
                                                            <option value="RETURN">Return</option>
                                                            <option value="OTHER">Other</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <!-- Supplier selection (shown for Stock In + Purchase Order) -->
                                                    <div class="reference-fields" id="supplier_fields_{{ material.id }}" style="display: none;">
                                                        <div class="mb-3">
                                                            <label for="supplier_{{ material.id }}" class="form-label">Supplier</label>
                                                            <select class="form-select supplier-select" id="supplier_{{ material.id }}" name="supplier_id">
                                                                <option value="">Select Supplier</option>
                                                                {% for supplier in suppliers %}
                                                                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3" id="purchase_field_{{ material.id }}" style="display: none;">
                                                            <label for="purchase_{{ material.id }}" class="form-label">Purchase Order</label>
                                                            <select class="form-select" id="purchase_{{ material.id }}" name="purchase_id">
                                                                <option value="">Select Purchase Order</option>
                                                                <!-- Will be dynamically populated -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Customer selection (shown for Stock Out + Sale Order) -->
                                                    <div class="reference-fields" id="customer_fields_{{ material.id }}" style="display: none;">
                                                        <div class="mb-3">
                                                            <label for="customer_{{ material.id }}" class="form-label">Customer</label>
                                                            <select class="form-select customer-select" id="customer_{{ material.id }}" name="customer_id">
                                                                <option value="">Select Customer</option>
                                                                {% for customer in customers %}
                                                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3" id="delivery_type_field_{{ material.id }}" style="display: none;">
                                                            <label for="delivery_type_{{ material.id }}" class="form-label">Delivery Type</label>
                                                            <select class="form-select delivery-type-select" id="delivery_type_{{ material.id }}" name="delivery_type">
                                                                <option value="all">All Deliveries</option>
                                                                <option value="regular">Regular Deliveries</option>
                                                                <option value="concrete">Concrete Deliveries</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3" id="delivery_field_{{ material.id }}" style="display: none;">
                                                            <label for="delivery_{{ material.id }}" class="form-label">Delivery Order</label>
                                                            <select class="form-select" id="delivery_{{ material.id }}" name="delivery_id">
                                                                <option value="">Select Delivery</option>
                                                                <!-- Will be dynamically populated -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Reference-specific guidance notes -->
                                                    <div id="reference_note_{{ material.id }}" class="reference-note bg-light">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        <span id="reference_note_text_{{ material.id }}">Select reference type and entry type to continue.</span>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="notes_{{ material.id }}" class="form-label">Notes</label>
                                                        <textarea class="form-control" id="notes_{{ material.id }}" name="notes" rows="2" placeholder="Optional: Add any relevant details"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bi bi-check-circle me-1"></i>Update Stock
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="bi bi-box fs-1 d-block mb-3 text-muted"></i>
                                {% if search_query or stock_status or last_updated %}
                                No materials match your filter criteria.
                                <div class="mt-3">
                                    <a href="{% url 'materials:inventory_list' %}" class="btn btn-outline-primary btn-sm">Clear filters and show all</a>
                                </div>
                                {% else %}
                                No materials found in the inventory.
                                <div class="mt-3">
                                    <a href="{% url 'materials:material_create' %}" class="btn btn-primary btn-sm">Add your first material</a>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="card shadow mt-4">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Inventory Activity</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date & Time</th>
                            <th>Material</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Reference</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                            {% for entry in material.recent_entries %}
                                <tr>
                                    <td>{{ entry.date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ entry.material.name }}</td>
                                    <td>
                                        {% if entry.entry_type == 'IN' %}
                                            <span class="badge bg-success">Stock In</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Stock Out</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ entry.quantity }} {{ entry.material.unit }}</td>
                                    <td>{{ entry.get_reference_type_display }}</td>
                                    <td>{{ entry.notes|default:"-"|truncatechars:30 }}</td>
                                </tr>
                            {% endfor %}
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <i class="bi bi-activity text-muted mb-2 d-block" style="font-size: 2rem;"></i>
                                    No recent inventory activity.
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit form when select fields change
        document.querySelectorAll('#stock_status, #last_updated').forEach(function(select) {
            select.addEventListener('change', function() {
                document.getElementById('inventory-filter-form').submit();
            });
        });
        
        // Add warning for negative stock in modals
        document.querySelectorAll('[id^="entry_type_"]').forEach(function(select) {
            select.addEventListener('change', function() {
                const materialId = this.id.split('_').pop();
                const quantityField = document.getElementById('quantity_' + materialId);
                const modalBody = this.closest('.modal-body');
                const referenceTypeSelect = document.getElementById('reference_type_' + materialId);
                
                // Remove any existing warning
                const existingWarning = modalBody.querySelector('.negative-stock-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                // Add warning for stock out operations
                if (this.value === 'OUT') {
                    const stockInfo = document.createElement('div');
                    stockInfo.className = 'alert alert-warning negative-stock-warning mt-3';
                    stockInfo.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Warning: Removing more than the current stock will result in negative inventory.';
                    modalBody.insertBefore(stockInfo, quantityField.closest('.mb-3').nextSibling);
                }
                
                // Update visible fields based on entry type and reference type
                updateReferenceFields(materialId, this.value, referenceTypeSelect.value);
            });
        });
        
        // Show reference-specific fields and guidance notes
        document.querySelectorAll('.reference-type-select').forEach(function(select) {
            select.addEventListener('change', function() {
                const materialId = this.id.split('_').pop();
                const entryTypeSelect = document.getElementById('entry_type_' + materialId);
                
                // Update visible fields based on entry type and reference type
                updateReferenceFields(materialId, entryTypeSelect.value, this.value);
            });
        });
        
        // Handle supplier selection
        document.querySelectorAll('.supplier-select').forEach(function(select) {
            select.addEventListener('change', function() {
                const materialId = this.id.split('_').pop();
                const purchaseField = document.getElementById('purchase_field_' + materialId);
                const purchaseSelect = document.getElementById('purchase_' + materialId);
                
                // Clear existing options
                while (purchaseSelect.options.length > 1) {
                    purchaseSelect.remove(1);
                }
                
                // Show purchase field only when a supplier is selected
                if (this.value) {
                    purchaseField.style.display = 'block';
                    
                    // Construct the correct API URL
                    const apiUrl = `/suppliers/api/${this.value}/purchase-orders/`;
                    console.log('Fetching purchase orders from:', apiUrl);
                    
                    // Fetch real purchase orders for the selected supplier
                    fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('API response data:', data);
                            if (data.purchase_orders && data.purchase_orders.length > 0) {
                                data.purchase_orders.forEach(purchase => {
                                    const option = document.createElement('option');
                                    option.value = purchase.id;
                                    option.textContent = `PO-${purchase.id} - ${purchase.purchase_date} - ₹${purchase.total_amount}`;
                                    purchaseSelect.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.disabled = true;
                                option.textContent = 'No purchase orders found for this supplier';
                                purchaseSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching purchase orders:', error);
                            const option = document.createElement('option');
                            option.disabled = true;
                            option.textContent = 'Error loading purchase orders';
                            purchaseSelect.appendChild(option);
                        });
                } else {
                    purchaseField.style.display = 'none';
                }
            });
        });
        
        // Handle customer selection
        document.querySelectorAll('.customer-select').forEach(function(select) {
            select.addEventListener('change', function() {
                const materialId = this.id.split('_').pop();
                const deliveryTypeField = document.getElementById('delivery_type_field_' + materialId);
                const deliveryField = document.getElementById('delivery_field_' + materialId);
                const deliverySelect = document.getElementById('delivery_' + materialId);
                
                // Clear existing options
                while (deliverySelect.options.length > 1) {
                    deliverySelect.remove(1);
                }
                
                // Show delivery type and delivery fields only when a customer is selected
                if (this.value) {
                    deliveryTypeField.style.display = 'block';
                    deliveryField.style.display = 'block';
                    
                    // Store customer ID for later use
                    deliveryTypeField.dataset.customerId = this.value;
                    
                    console.log('Fetching deliveries for customer ID:', this.value);
                    
                    // Fetch both types of deliveries in parallel
                    Promise.all([
                        // Regular deliveries
                        fetch(`/customers/api/deliveries/?customer=${this.value}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! Status: ${response.status}`);
                                }
                                return response.json();
                            }),
                        // Concrete deliveries
                        fetch(`/customers/api/concrete-deliveries/?customer=${this.value}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! Status: ${response.status}`);
                                }
                                return response.json();
                            })
                    ])
                    .then(([regularDeliveries, concreteDeliveries]) => {
                        console.log('API Response - Regular deliveries:', regularDeliveries);
                        console.log('API Response - Concrete deliveries:', concreteDeliveries);
                        
                        // Ensure we have arrays for both delivery types
                        const regularDeliveriesArray = Array.isArray(regularDeliveries) ? regularDeliveries : [];
                        const concreteDeliveriesArray = Array.isArray(concreteDeliveries) ? concreteDeliveries : [];
                        
                        // Store fetched deliveries in data attributes for filtering
                        deliveryTypeField.dataset.regularDeliveries = JSON.stringify(regularDeliveriesArray);
                        deliveryTypeField.dataset.concreteDeliveries = JSON.stringify(concreteDeliveriesArray);
                        
                        // Initially populate with all deliveries
                        populateDeliveryDropdown(materialId, 'all', regularDeliveriesArray, concreteDeliveriesArray);
                    })
                    .catch(error => {
                        console.error('Error fetching deliveries:', error);
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'Error loading deliveries';
                        deliverySelect.appendChild(option);
                    });
                } else {
                    deliveryTypeField.style.display = 'none';
                    deliveryField.style.display = 'none';
                }
            });
        });
        
        // Handle delivery type selection
        document.querySelectorAll('.delivery-type-select').forEach(function(select) {
            select.addEventListener('change', function() {
                const materialId = this.id.split('_').pop();
                console.log('Delivery type changed to:', this.value);
                
                try {
                    const regularDeliveries = JSON.parse(this.dataset.regularDeliveries || '[]');
                    const concreteDeliveries = JSON.parse(this.dataset.concreteDeliveries || '[]');
                    
                    console.log('Parsed regular deliveries:', regularDeliveries);
                    console.log('Parsed concrete deliveries:', concreteDeliveries);
                    
                    // Filter and populate deliveries based on selected type
                    populateDeliveryDropdown(materialId, this.value, regularDeliveries, concreteDeliveries);
                } catch (error) {
                    console.error('Error parsing delivery data:', error);
                    const deliverySelect = document.getElementById('delivery_' + materialId);
                    
                    // Clear existing options except the first placeholder
                    while (deliverySelect.options.length > 1) {
                        deliverySelect.remove(1);
                    }
                    
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'Error loading deliveries';
                    deliverySelect.appendChild(option);
                }
            });
        });
        
        // Helper function to update reference fields visibility
        function updateReferenceFields(materialId, entryType, referenceType) {
            const noteElement = document.getElementById('reference_note_' + materialId);
            const noteTextElement = document.getElementById('reference_note_text_' + materialId);
            const supplierFields = document.getElementById('supplier_fields_' + materialId);
            const customerFields = document.getElementById('customer_fields_' + materialId);
            
            // Hide all reference field containers initially
            supplierFields.style.display = 'none';
            customerFields.style.display = 'none';
            
            // Show note element by default
            noteElement.classList.add('show');
            
            // Determine which fields to show based on entry type and reference type
            if (entryType === 'IN' && referenceType === 'PURCHASE') {
                supplierFields.style.display = 'block';
                noteTextElement.textContent = 'Select the supplier who provided these materials';
            } else if (entryType === 'OUT' && referenceType === 'SALE') {
                customerFields.style.display = 'block';
                noteTextElement.textContent = 'Select the customer who received these materials';
            } else if (referenceType === 'ADJUSTMENT') {
                noteTextElement.textContent = 'Manual adjustment - please provide details in the notes field';
            } else if (referenceType === 'RETURN') {
                if (entryType === 'IN') {
                    noteTextElement.textContent = 'Customer return - please specify customer details in notes';
                } else {
                    noteTextElement.textContent = 'Supplier return - please specify supplier details in notes';
                }
            } else {
                noteTextElement.textContent = 'Please provide all relevant details in the notes field';
            }
        }
        
        // Helper function to populate delivery dropdown based on type
        function populateDeliveryDropdown(materialId, deliveryType, regularDeliveries, concreteDeliveries) {
            const deliverySelect = document.getElementById('delivery_' + materialId);
            
            // Debug info
            console.log('Populating delivery dropdown with:');
            console.log('Regular deliveries:', regularDeliveries);
            console.log('Concrete deliveries:', concreteDeliveries);
            
            // Clear existing options except the first placeholder
            while (deliverySelect.options.length > 1) {
                deliverySelect.remove(1);
            }
            
            let hasDeliveries = false;
            
            // Add regular deliveries if selected type is 'all' or 'regular'
            if ((deliveryType === 'all' || deliveryType === 'regular') && regularDeliveries && regularDeliveries.length) {
                regularDeliveries.forEach(delivery => {
                    console.log('Processing regular delivery:', delivery);
                    // Handle date from API response (could be 'date' or 'delivery_date')
                    let dateValue = delivery.date || delivery.delivery_date;
                    let date = new Date(dateValue);
                    let formattedDate = date.toISOString().split('T')[0];
                    
                    // Calculate balance - adapt to API response fields
                    let balance = delivery.balance || (delivery.total_amount - delivery.received_amount);
                    let status = balance <= 0 ? 'Paid' : 'Due';
                    
                    const option = document.createElement('option');
                    option.value = `regular_${delivery.id}`;
                    option.textContent = `${delivery.invoice_number} - ${formattedDate} - ${status}`;
                    deliverySelect.appendChild(option);
                });
                hasDeliveries = hasDeliveries || regularDeliveries.length > 0;
            }
            
            // Add concrete deliveries if selected type is 'all' or 'concrete'
            if ((deliveryType === 'all' || deliveryType === 'concrete') && concreteDeliveries && concreteDeliveries.length) {
                concreteDeliveries.forEach(delivery => {
                    console.log('Processing concrete delivery:', delivery);
                    // Handle different date field names
                    let dateValue = delivery.delivery_date || delivery.date;
                    let date = new Date(dateValue);
                    let formattedDate = date.toISOString().split('T')[0];
                    
                    // Calculate balance - adapt to API response fields
                    let balance = delivery.balance || (delivery.total_amount - delivery.received_amount);
                    let status = balance <= 0 ? 'Paid' : 'Due';
                    
                    const option = document.createElement('option');
                    option.value = `concrete_${delivery.id}`;
                    option.textContent = `${delivery.invoice_number} (Concrete) - ${formattedDate} - ${status}`;
                    deliverySelect.appendChild(option);
                });
                hasDeliveries = hasDeliveries || concreteDeliveries.length > 0;
            }
            
            // Add a message if no deliveries are found for the selected type
            if (!hasDeliveries) {
                console.log('No deliveries found for type:', deliveryType);
                const option = document.createElement('option');
                option.disabled = true;
                
                if (deliveryType === 'all') {
                    option.textContent = 'No deliveries found for this customer';
                } else if (deliveryType === 'regular') {
                    option.textContent = 'No regular deliveries found for this customer';
                } else if (deliveryType === 'concrete') {
                    option.textContent = 'No concrete deliveries found for this customer';
                }
                
                deliverySelect.appendChild(option);
            }
        }
    });
</script>
{% endblock %} 